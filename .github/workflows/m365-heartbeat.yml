name: M365 Developer Heartbeat

on:
  schedule:
    - cron: "0 7 * * *"
  workflow_dispatch:

jobs:
  run-heartbeat:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run Heartbeat Script
        id: heartbeat
        shell: pwsh
        env:
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        # If your script is in a "Scripts" folder, change the path below to ./Scripts/daily-heartbeat.ps1
        run: |
          ./Scripts/daily-heartbeat.ps1 -TenantId "$env:TENANT_ID" -ClientId "$env:CLIENT_ID" -ClientSecret "$env:CLIENT_SECRET"

      - name: Find heartbeat report
        id: find_report
        # This looks for the most recent report generated by your script
        run: |
          FILE=$(ls heartbeat-report-*.json | head -n 1)
          echo "file=$FILE" >> $GITHUB_OUTPUT

      - name: Send Mail
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: M365 Heartbeat Summary
          body: "Your daily Microsoft 365 Developer Heartbeat summary is attached."
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_FROM }}
          attachments: ${{ steps.find_report.outputs.file }}
